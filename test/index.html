<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title></title>
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="" />
    <link rel="shortcut icon" href="#" />
  </head>
  <body>
    <div
      style="
        display: flex;
        flex-direction: column;
        max-width: 1000px;
        margin: auto;
        justify-items: center;
        justify-content: center;
        align-content: center;
        align-items: center;
      "
    >
      <button
        id="signin"
        style="
          display: none;
          box-shadow: none;
          cursor: pointer;
          margin-top: 20px;
          background-color: purple;
          color: white;
          width: 250px;
          padding: 10px;
          font-size: large;
          border-color: purple;
          /* border: solid; */
          border-radius: 0px;
        "
      >
        Sign In
      </button>
      <button
        id="cognito"
        style="
          box-shadow: none;
          cursor: pointer;
          margin-top: 20px;
          background-color: purple;
          color: white;
          width: 250px;
          padding: 10px;
          font-size: large;
          border-color: purple;
          border-radius: 0px;
        "
      >
        Cognito Hosted UI
      </button>
      <button
        id="currentUrl"
        style="
          display: none;
          box-shadow: none;
          cursor: pointer;
          margin-top: 20px;
          background-color: purple;
          color: white;
          width: 250px;
          padding: 10px;
          font-size: large;
          border-color: purple;
          border-radius: 0px;
        "
      >
        Get Current Url
      </button>
    </div>
    <!-- <script src="./axios.min.js"></script> -->
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script src="https://d2cvlmmg8c0xrp.cloudfront.net/cognito-demo/axios.min.js"></script>
    <script src="https://d2cvlmmg8c0xrp.cloudfront.net/cognito-demo/config.js" type="module"></script>
    <script type="module">
      import { config } from "./config.js";
      console.log("sign in an user to cognito user pool");

      const getToken = () => {
        axios
          .request({
            method: "POST",
            url: config.url,
            headers: {
              "Content-Type": "application/x-amz-json-1.1",
              "X-Amz-Target": "AWSCognitoIdentityProviderService.InitiateAuth",
            },
            data: {
              AuthFlow: "USER_PASSWORD_AUTH",
              AuthParameters: {
                PASSWORD: config.password,
                USERNAME: config.username,
              },
              ClientId: config.clientId,
            },
          })
          .then((response) => {
            console.log(response.data);
          });
      };

      const cognitoUI = async () => {
        // open the cognito hosted ui
        window.location.replace(config.cognitoUrl);
        console.log("cognito hosted ui");

        // if logged in successfully then parse the code from url
      };

      const getCurrentUrl = async () => {
        const code = window.location.href.split("=").pop();
        console.log(code);
        axios
          .request({
            method: "POST",
            url: config.tokenEndpoint,
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            data: {
              grant_type: "authorization_code",
              code: code,
              redirect_uri: config.redirectUrl,
              client_id: config.clientId,
            },
          })
          .then((response) => {
            console.log(response.data);
            localStorage.setItem("IdToken", response.data.id_token);
            localStorage.setItem("AccessToken", response.data.access_token);
            window.location.replace("https://d2cvlmmg8c0xrp.cloudfront.net/cognito-demo/profile.html");
            return JSON.stringify(response.data);
          })
          .catch((error) => {
            console.log(error);
            return null;
          });
      };




      document.getElementById("signin").addEventListener("click", getToken);
      document.getElementById("cognito").addEventListener("click", cognitoUI);
      document
        .getElementById("currentUrl")
        .addEventListener("click", getCurrentUrl);

      // document.onreadystatechange = () => {
      //   console.log("location change ", window.location.href);
      //   if (
      //     window.location.href != "http://localhost:5500/index.html" &&
      //     window.location.href != "http://localhost:5500/"
      //   ) {
      //     const user = getCurrentUrl();
      //   }
      // };

      window.onload = () => {
        console.log("location change ", window.location.href);
        if (
          window.location.href != "https://d2cvlmmg8c0xrp.cloudfront.net/cognito-demo/index.html" &&
          window.location.href != "https://d2cvlmmg8c0xrp.cloudfront.net/cognito-demo/"
        ) {
          const user = getCurrentUrl();
        }
      };
    </script>
  </body>
</html>
